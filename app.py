# ุงุณุชูุฑุงุฏ ุงูููุชุจุงุช ุงูุถุฑูุฑูุฉ ูุงููุธุงุฆู ูู ุงููููุงุช ุงูุฃุฎุฑู
import streamlit as st  # ููุชุจุฉ Streamlit ูุฅูุดุงุก ูุงุฌูุงุช ุงููุณุชุฎุฏู
from database import init_database, get_all_reviews, create_code_review  # ูุธุงุฆู ูุฅุฏุงุฑุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
from config import PROGRAMMING_LANGUAGES  # ูุงุฆูุฉ ุงููุบุงุช ุงูุจุฑูุฌูุฉ ุงููุฏุนููุฉ
from ai import perform_code_review_with_qroq  # ูุธููุฉ ููููุงู ุจูุฑุงุฌุนุฉ ุงูููุฏ ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู
import time  # ููุชุจุฉ ูุฅุถุงูุฉ ูุงุตู ุฒููู
from utils import extract_code_quality_score  # ูุธููุฉ ูุงุณุชุฎุฑุงุฌ ุฏุฑุฌุฉ ุฌูุฏุฉ ุงูููุฏ ูู ุงููุฑุงุฌุนุฉ

# ุชุนุฑูู ูุธููุฉ ุงูุดุฑูุท ุงูุฌุงูุจู
def sidebar_menu():
    # ุฅุถุงูุฉ ุนููุงู ุฅูู ุงูุดุฑูุท ุงูุฌุงูุจู
    st.sidebar.title("Review History")

    # ุฌูุจ ุฌููุน ุงููุฑุงุฌุนุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    reviews = get_all_reviews()

    # ุญุงูุฉ ุชุณุชุฎุฏู ูุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ููุงู ูุฑุงุฌุนุฉ ููุฏ ุงูุนุฑุถ
    st.session_state['is_active'] = False

    # ุนุฑุถ ุฃูู 5 ูุฑุงุฌุนุงุช ููุท ูู ุงูุดุฑูุท ุงูุฌุงูุจู
    for review in reviews[:5]:
        text = review['question'][:33]  # ุฃุฎุฐ ุฃูู 33 ุญุฑููุง ููุท ูู ูุต ุงูููุฏ ููุณุคุงู
        if st.sidebar.button(text, key=review['id']):  # ุฅูุดุงุก ุฒุฑ ููู ูุฑุงุฌุนุฉ
            display_json_review(review['answer'])  # ุนุฑุถ ุงููุฑุงุฌุนุฉ ุงููุงููุฉ ุนูุฏ ุงูุถุบุท ุนูู ุงูุฒุฑ

# ุชุนุฑูู ูุธููุฉ ูุนุฑุถ ูุฑุงุฌุนุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู
def display_json_review(review_data):
    # ุนุฑุถ ูุต ุงููุฑุงุฌุนุฉ ุจุงุณุชุฎุฏุงู Markdown
    st.markdown(review_data)

# ุงููุธููุฉ ุงูุฑุฆูุณูุฉ ููุชุทุจูู
def main():
    # ุถุจุท ุฅุนุฏุงุฏุงุช ุตูุญุฉ ุงูุชุทุจูู (ุงูุนููุงู ูุงูุฃููููุฉ)
    st.set_page_config(page_title="AI Code Review Assistant", page_icon="๐ค")

    # ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุนูุฏ ุจุฏุก ุงูุชุทุจูู
    init_database()

    # ุฅุถุงูุฉ ุงูุดุฑูุท ุงูุฌุงูุจู ููุชุทุจูู
    sidebar_menu()

    # ุนุฑุถ ุนููุงู ุฑุฆูุณู ูู ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ
    st.title("AI Code Review Assistant")

    # ุงุฎุชูุงุฑ ูุบุฉ ุงูุจุฑูุฌุฉ ูู ูุงุฆูุฉ ููุณุฏูุฉ
    language = st.selectbox("Programming Language", options=PROGRAMMING_LANGUAGES)

    # ุฅุฏุฎุงู ุงูููุฏ ุงููุทููุจ ูุฑุงุฌุนุชู ุนุจุฑ ูุฑุจุน ูุต
    code_input = st.text_area("Code to Review", height=200)

    # ุฒุฑ ููุจุฏุก ูู ุนูููุฉ ูุฑุงุฌุนุฉ ุงูููุฏ
    if st.button("Review Code"):
        with st.spinner("Analyzing Code..."):  # ุนุฑุถ ูุคุดุฑ ุชุญููู ุฃุซูุงุก ุงูุนูููุฉ
            time.sleep(1)  # ุชุฃุฎูุฑ ุจุณูุท ูุชุฌุฑุจุฉ ุงููุณุชุฎุฏู (ุบูุฑ ุถุฑูุฑู ูู ุงูุฅูุชุงุฌ)

            # ุงุณุชุฏุนุงุก ูุธููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุชุญููู ุงูููุฏ
            review_data = perform_code_review_with_qroq(code_input, language)

            # ุนุฑุถ ูุชูุฌุฉ ูุฑุงุฌุนุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู
            display_json_review(review_data)

            # ุงุณุชุฎุฑุงุฌ ุฏุฑุฌุฉ ุฌูุฏุฉ ุงูููุฏ ูู ุงููุฑุงุฌุนุฉ
            score = extract_code_quality_score(review_data)

            # ุญูุธ ุจูุงูุงุช ุงููุฑุงุฌุนุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            create_code_review(
                question=code_input,  # ุงูููุฏ ุงูุฐู ุฃุฏุฎูู ุงููุณุชุฎุฏู
                answer=review_data,  # ูุฑุงุฌุนุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู
                language=language,  # ุงููุบุฉ ุงูุจุฑูุฌูุฉ ุงููุฎุชุงุฑุฉ
                score=score  # ุฏุฑุฌุฉ ุฌูุฏุฉ ุงูููุฏ
            )

            # ุชุญุฏูุซ ูุงุฌูุฉ ุงูุชุทุจูู ูุชุธูุฑ ุงููุฑุงุฌุนุงุช ุงูุฌุฏูุฏุฉ ูู ุงูุดุฑูุท ุงูุฌุงูุจู
            # ูููู ุฅุนุงุฏุฉ ุชูููู ุงูุฃุณุทุฑ ุฃุฏูุงู ุนูุฏ ุงูุญุงุฌุฉ
            # close_connection()
            # st.rerun()

# ููุทุฉ ุงูุจุฏุงูุฉ ูุชุดุบูู ุงูุชุทุจูู
if __name__ == "__main__":
    main()  # ุงุณุชุฏุนุงุก ุงููุธููุฉ ุงูุฑุฆูุณูุฉ ุนูุฏ ุชุดุบูู ุงูููู
